---
title: "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã Python Consumer"
description: "–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫, exactly-once —Å–µ–º–∞–Ω—Ç–∏–∫–∞ –∏ production-ready –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"
order: 1
difficulty: "advanced"
estimatedTime: 45
topics: ["Python", "confluent-kafka", "Exactly-Once", "Error Handling", "Transactions"]
prerequisites: ["module-1/05-python-consumer"]
---

import { Mermaid } from '../../../components/Mermaid.tsx';

# –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã Python Consumer

–í [Module 1](/course/module-1/05-python-consumer) –º—ã –Ω–∞–ø–∏—Å–∞–ª–∏ –±–∞–∑–æ–≤—ã–π Python consumer —Å –ø—Ä–æ—Å—Ç–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π. –≠—Ç–æ –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –∏ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∏—Ä–æ–≤–∞–Ω–∏—è, –Ω–æ –¥–ª—è production-—Å–∏—Å—Ç–µ–º —Ç—Ä–µ–±—É—é—Ç—Å—è –±–æ–ª–µ–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã.

## –û—Ç tutorial –∫ production

**–ë–∞–∑–æ–≤—ã–π consumer –∏–∑ Module 1:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit offset
- –ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (print –∏ continue)
- At-most-once —Å–µ–º–∞–Ω—Ç–∏–∫–∞ (–¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è –ø—Ä–∏ —Å–±–æ–µ)

**Production-ready consumer:**
- –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–∞—è —Å–µ–º–∞–Ω—Ç–∏–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ (at-least-once –∏–ª–∏ exactly-once)
- –†–∞–∑–ª–∏—á–µ–Ω–∏–µ fatal –∏ non-fatal –æ—à–∏–±–æ–∫
- Graceful shutdown –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ rebalancing
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ observability

–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã —Ä–∞–∑–±–µ—Ä–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç consumer –≥–æ—Ç–æ–≤—ã–º –∫ production.

---

## At-Least-Once vs Exactly-Once —Å–µ–º–∞–Ω—Ç–∏–∫–∞

Kafka –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç—Ä–∏ –≥–∞—Ä–∞–Ω—Ç–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:

### At-Most-Once (–º–∞–∫—Å–∏–º—É–º –æ–¥–∏–Ω —Ä–∞–∑)
- –°–æ–æ–±—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω–æ, –Ω–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–≤–∞–∂–¥—ã
- Commit offset **–¥–æ** –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–¥–∫–æ (–ª–æ–≥–∏, –º–µ—Ç—Ä–∏–∫–∏, –≥–¥–µ –ø–æ—Ç–µ—Ä—è –ø—Ä–∏–µ–º–ª–µ–º–∞)

### At-Least-Once (–º–∏–Ω–∏–º—É–º –æ–¥–∏–Ω —Ä–∞–∑)
- –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–≤–∞–∂–¥—ã
- Commit offset **–ø–æ—Å–ª–µ** –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **–°–∞–º–∞—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–∞—è —Å–µ–º–∞–Ω—Ç–∏–∫–∞ –¥–ª—è CDC**
- –¢—Ä–µ–±—É–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### Exactly-Once (—Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑)
- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ (–Ω–∏–∫–∞–∫–æ–π –ø–æ—Ç–µ—Ä–∏, –Ω–∏–∫–∞–∫–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–π API Kafka
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (—Ñ–∏–Ω–∞–Ω—Å—ã, –ø–ª–∞—Ç–µ–∂–∏, inventory)

<Mermaid chart={`
graph TD
    subgraph "At-Least-Once"
        A1[–ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ] --> A2[–û–±—Ä–∞–±–æ—Ç–∞—Ç—å]
        A2 --> A3[Commit offset]
        A3 --> A4{Crash?}
        A4 -->|–î–æ commit| A5[–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞]
        A4 -->|–ü–æ—Å–ª–µ commit| A6[OK]
    end

    subgraph "Exactly-Once"
        B1[–ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ] --> B2[Begin Transaction]
        B2 --> B3[–û–±—Ä–∞–±–æ—Ç–∞—Ç—å]
        B3 --> B4[Produce —Ä–µ–∑—É–ª—å—Ç–∞—Ç]
        B4 --> B5[Commit offset –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏]
        B5 --> B6[Commit Transaction]
        B6 --> B7{Crash?}
        B7 -->|–î–æ commit| B8[Rollback –≤—Å–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏]
        B7 -->|–ü–æ—Å–ª–µ commit| B9[OK –∞—Ç–æ–º–∞—Ä–Ω–æ]
    end

    style A5 fill:#ff6b6b
    style B8 fill:#ff6b6b
    style A6 fill:#51cf66
    style B9 fill:#51cf66
`} client:visible />

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫—É—é —Å–µ–º–∞–Ω—Ç–∏–∫—É:**

| –°–µ–º–∞–Ω—Ç–∏–∫–∞ | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å | –ü—Ä–∏–º–µ—Ä |
|-----------|-------------------|--------|
| **At-Least-Once** | –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–º–æ–∂–Ω–∞ (upsert –≤ –ë–î, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ cache) | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –ø–æ–∏—Å–∫–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ materialized view |
| **Exactly-Once** | –ö—Ä–∏—Ç–∏—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ (—Å—á–µ—Ç—á–∏–∫–∏, —Ñ–∏–Ω–∞–Ω—Å—ã) | –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π, —Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ —Å—á–µ—Ç–∞, –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ |
| **At-Most-Once** | –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–µ–º–ª–µ–º–∞, –¥—É–±–ª–∏–∫–∞—Ç—ã –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫, –æ—Ç–ø—Ä–∞–≤–∫–∞ email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π |

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è At-Least-Once

–î–ª—è at-least-once —Å–µ–º–∞–Ω—Ç–∏–∫–∏ –Ω—É–∂–Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ offset –∫–æ–º–º–∏—Ç–∏—Ç—Å—è **—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ** —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.

### –ü–∞—Ç—Ç–µ—Ä–Ω: Manual Offset Store

```python
from confluent_kafka import Consumer, KafkaException

config = {
    'bootstrap.servers': 'kafka:9092',
    'group.id': 'cdc-processor',
    'auto.offset.reset': 'earliest',
    'enable.auto.commit': True,          # –ê–≤—Ç–æ-commit –≤–∫–ª—é—á–µ–Ω
    'enable.auto.offset.store': False    # Manual store –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è
}

consumer = Consumer(config)
consumer.subscribe(['dbserver1.public.orders'])

try:
    while True:
        msg = consumer.poll(timeout=1.0)
        if msg is None:
            continue

        if msg.error():
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (—Å–º. —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª)
            continue

        try:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            process_cdc_event(msg.value())

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º offset –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
            consumer.store_offsets(msg)

        except Exception as e:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å - –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º offset
            # –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ consumer –ø–æ–≤—Ç–æ—Ä–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É
            print(f"Processing failed: {e}")
            continue

finally:
    consumer.close()
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –ü–æ—á–µ–º—É |
|----------|----------|--------|
| `enable.auto.commit` | `True` | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π commit –≤ —Ñ–æ–Ω–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) |
| `enable.auto.offset.store` | `False` | **–ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç:** offset —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ `store_offsets()` |

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. Consumer –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
2. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
3. –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–∞ ‚Üí `store_offsets(msg)` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç offset
4. –§–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ –∞–≤—Ç–æ-commit –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∫–æ–º–º–∏—Ç–∏—Ç –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ offset
5. –ï—Å–ª–∏ crash –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–æ `store_offsets()` ‚Üí –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ consumer –ø–æ–≤—Ç–æ—Ä–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É

**–ì–∞—Ä–∞–Ω—Ç–∏—è:** –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω–æ (–Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–≤–∞–∂–¥—ã –ø—Ä–∏ —Å–±–æ–µ).

---

## Exactly-Once —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–º API

–î–ª—è exactly-once —Å–µ–º–∞–Ω—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–π API Kafka, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —á—Ç–µ–Ω–∏–µ, –æ–±—Ä–∞–±–æ—Ç–∫—É –∏ –∑–∞–ø–∏—Å—å –≤ –æ–¥–Ω—É –∞—Ç–æ–º–∞—Ä–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é.

### –ü–∞—Ç—Ç–µ—Ä–Ω: Transactional Consumer-Producer

```python
from confluent_kafka import Consumer, Producer, KafkaException

# ==============================================================================
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è transactional Producer
# ==============================================================================
producer_config = {
    'bootstrap.servers': 'kafka:9092',
    'transactional.id': 'cdc-transformer-1',  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∫–∞–∂–¥–æ–≥–æ instance
    'enable.idempotence': True                 # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
}

producer = Producer(producer_config)
producer.init_transactions()  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–≥–æ API

# ==============================================================================
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è read-committed Consumer
# ==============================================================================
consumer_config = {
    'bootstrap.servers': 'kafka:9092',
    'group.id': 'cdc-processor',
    'isolation.level': 'read_committed',  # –ß–∏—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ committed —Å–æ–æ–±—â–µ–Ω–∏—è
    'enable.auto.commit': False            # –†—É—á–Ω–æ–π commit —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
}

consumer = Consumer(consumer_config)
consumer.subscribe(['dbserver1.public.orders'])

# ==============================================================================
# –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏
# ==============================================================================
try:
    while True:
        msg = consumer.poll(timeout=1.0)
        if msg is None:
            continue

        if msg.error():
            raise KafkaException(msg.error())

        # –ù–∞—á–∞–ª–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        producer.begin_transaction()

        try:
            # 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ CDC —Å–æ–±—ã—Ç–∏—è
            result = transform_cdc_event(msg.value())

            # 2. –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ output topic
            producer.produce('output-topic', value=result)

            # 3. Commit offset –∫–∞–∫ —á–∞—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            producer.send_offsets_to_transaction(
                consumer.position(consumer.assignment()),
                consumer.consumer_group_metadata()
            )

            # 4. Commit —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–∞—Ç–æ–º–∞—Ä–Ω–æ)
            producer.commit_transaction()

        except Exception as e:
            # –ü—Ä–∏ –æ—à–∏–±–∫–µ - abort —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            producer.abort_transaction()
            print(f"Transaction aborted: {e}")
            # –°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ

finally:
    consumer.close()
```

**–ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ì–¥–µ | –ó–Ω–∞—á–µ–Ω–∏–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|----------|-----|----------|-----------|
| `transactional.id` | Producer | `cdc-transformer-1` | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏. –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å —Ç–µ–º –∂–µ ID Kafka –∑–∞–≤–µ—Ä—à–∏—Ç –Ω–µ–∑–∞–∫–æ–Ω—á–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ |
| `enable.idempotence` | Producer | `True` | –û–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –¥—É–±–ª–∏–∫–∞—Ç—ã –Ω–µ –±—É–¥—É—Ç –∑–∞–ø–∏—Å–∞–Ω—ã |
| `isolation.level` | Consumer | `read_committed` | –ß–∏—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ committed —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–µ –≤–∏–¥–µ—Ç—å aborted —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏) |
| `enable.auto.commit` | Consumer | `False` | Offset —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `send_offsets_to_transaction()` |

**–ì–∞—Ä–∞–Ω—Ç–∏–∏ exactly-once:**
1. –õ–∏–±–æ –≤—Å—ë –≤—ã–ø–æ–ª–Ω–∏–ª–æ—Å—å (–æ–±—Ä–∞–±–æ—Ç–∫–∞ + produce + offset commit), –ª–∏–±–æ –Ω–∏—á–µ–≥–æ
2. –î—É–±–ª–∏–∫–∞—Ç—ã –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã (idempotence + transactional.id)
3. –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ (offset commit –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)

**–í–∞–∂–Ω–æ:** Exactly-once —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è Kafka ‚Üí –æ–±—Ä–∞–±–æ—Ç–∫–∞ ‚Üí Kafka –ø–∞—Ç—Ç–µ—Ä–Ω–∞. –î–ª—è –∑–∞–ø–∏—Å–∏ –≤ –ë–î —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

---

## –í–ê–ñ–ù–û: kafka:9092 vs localhost:9092

> **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫–æ–π –∞–¥—Ä–µ—Å?**
>
> | –ì–¥–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ –∫–æ–¥ | –ê–¥—Ä–µ—Å Kafka |
> |--------------------|-------------|
> | **–í–Ω—É—Ç—Ä–∏ Docker** (JupyterLab, –¥—Ä—É–≥–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã) | `kafka:9092` |
> | **–ù–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ** (—Ç–µ—Ä–º–∏–Ω–∞–ª Mac/Windows/Linux) | `localhost:9092` |
>
> **–í –ø—Ä–∏–º–µ—Ä–∞—Ö —ç—Ç–æ–≥–æ —É—Ä–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `kafka:9092` (JupyterLab).**
>
> –≠—Ç–æ —á–∞—Å—Ç–∞—è –ø—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ‚Äî –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ, –æ—Ç–∫—É–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤–∞—à –∫–æ–¥!

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: Fatal vs Non-Fatal

Consumer –º–æ–∂–µ—Ç –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å –¥–≤–∞ –∫–ª–∞—Å—Å–∞ –æ—à–∏–±–æ–∫:

### Non-Fatal Errors (–º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å)
- Partition EOF (–∫–æ–Ω–µ—Ü —Ä–∞–∑–¥–µ–ª–∞ ‚Äî —ç—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞, –∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–±–æ–∏ —Å–µ—Ç–∏ (reconnect –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- Rate limiting (retry —Å backoff)

### Fatal Errors (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å consumer)
- Authentication failure (–Ω–µ–≤–µ—Ä–Ω—ã–µ credentials)
- Authorization failure (–Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ —Ç–æ–ø–∏–∫–∞)
- Unknown topic or partition
- Broker failures (–≤—Å–µ –±—Ä–æ–∫–µ—Ä—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã)

```python
from confluent_kafka import Consumer, KafkaException, KafkaError

consumer = Consumer(config)
consumer.subscribe(['dbserver1.public.orders'])

try:
    while True:
        msg = consumer.poll(timeout=1.0)
        if msg is None:
            continue

        # ==============================================================================
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏
        # ==============================================================================
        if msg.error():
            error_code = msg.error().code()

            # Non-fatal: –∫–æ–Ω–µ—Ü —Ä–∞–∑–¥–µ–ª–∞ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
            if error_code == KafkaError._PARTITION_EOF:
                continue

            # Fatal: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ fatal()
            if msg.error().fatal():
                print(f"FATAL ERROR: {msg.error()}")
                raise KafkaException(msg.error())

            # Non-fatal: –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
            print(f"Non-fatal error: {msg.error()}")
            continue

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        try:
            process_message(msg)
            consumer.store_offsets(msg)
        except Exception as e:
            print(f"Processing error: {e}")
            continue

except KeyboardInterrupt:
    print("Shutting down...")
finally:
    consumer.close()
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**

| –û—à–∏–±–∫–∞ | –ö–æ–¥ | fatal() | –î–µ–π—Å—Ç–≤–∏–µ |
|--------|-----|---------|----------|
| `_PARTITION_EOF` | -191 | False | –î–æ—Å—Ç–∏–≥–Ω—É—Ç –∫–æ–Ω–µ—Ü —Ä–∞–∑–¥–µ–ª–∞. Continue. |
| `_TRANSPORT` | -195 | False | –°–µ—Ç–µ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞. Retry –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. |
| `_ALL_BROKERS_DOWN` | -187 | True | –í—Å–µ –±—Ä–æ–∫–µ—Ä—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. Raise exception. |
| `_AUTHENTICATION` | -169 | True | –ù–µ–≤–µ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è. Raise exception. |
| `_TOPIC_AUTHORIZATION_FAILED` | 29 | True | –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ç–æ–ø–∏–∫. Raise exception. |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ `msg.error().fatal()`
- Fatal errors ‚Üí –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω–µ –ø—ã—Ç–∞—Ç—å—Å—è retry)
- Non-fatal errors ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ non-fatal –æ—à–∏–±–æ–∫ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

---

## Rebalancing –∏ max.poll.interval.ms

**–ß–∞—Å—Ç–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** Consumer –≤—ã–≥–æ–Ω—è–µ—Ç—Å—è –∏–∑ –≥—Ä—É–ø–ø—ã –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—è–∂–µ–ª—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.

### –ß—Ç–æ —Ç–∞–∫–æ–µ rebalancing?

Consumer group –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ Group Coordinator. –ï—Å–ª–∏ consumer –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç `poll()` –≤ —Ç–µ—á–µ–Ω–∏–µ `max.poll.interval.ms`, –æ–Ω —Å—á–∏—Ç–∞–µ—Ç—Å—è "–º–µ—Ä—Ç–≤—ã–º" –∏ –≤—ã–≥–æ–Ω—è–µ—Ç—Å—è –∏–∑ –≥—Ä—É–ø–ø—ã.

<Mermaid chart={`
sequenceDiagram
    participant C as Consumer
    participant GC as Group Coordinator
    participant K as Kafka

    C->>K: poll() - –ø–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    Note over C: –û–±—Ä–∞–±–æ—Ç–∫–∞ (3 –º–∏–Ω—É—Ç—ã)
    C->>K: poll() - —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

    Note over GC: max.poll.interval.ms = 5 –º–∏–Ω—É—Ç
    Note over GC: –ï—Å–ª–∏ poll() –Ω–µ –≤—ã–∑–≤–∞–Ω 5 –º–∏–Ω—É—Ç ‚Üí REBALANCE

    C->>K: poll() –ø–æ—Å–ª–µ 6 –º–∏–Ω—É—Ç
    GC-->>C: ‚ùå Rebalancing triggered
    Note over C: Consumer removed from group
    Note over C: Partitions reassigned
`} client:visible />

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è rebalancing:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –î–µ—Ñ–æ–ª—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------|----------|
| `max.poll.interval.ms` | 300000 (5 –º–∏–Ω—É—Ç) | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –º–µ–∂–¥—É `poll()` –≤—ã–∑–æ–≤–∞–º–∏ |
| `max.poll.records` | 500 | –ú–∞–∫—Å–∏–º—É–º —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ –æ–¥–∏–Ω `poll()` |
| `session.timeout.ms` | 45000 (45 —Å–µ–∫—É–Ω–¥) | –¢–∞–π–º–∞—É—Ç heartbeat (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç `poll()`) |

### –†–µ—à–µ–Ω–∏–µ: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ batch size

```python
config = {
    'bootstrap.servers': 'kafka:9092',
    'group.id': 'cdc-processor',
    'max.poll.interval.ms': 300000,  # 5 –º–∏–Ω—É—Ç (–¥–µ—Ñ–æ–ª—Ç)
    'max.poll.records': 100,         # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –º–∞–∫—Å–∏–º—É–º 100 —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ poll()
    'enable.auto.offset.store': False
}

consumer = Consumer(config)
consumer.subscribe(['dbserver1.public.orders'])

# –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–Ω–∏–º–∞–µ—Ç 1 —Å–µ–∫—É–Ω–¥—É,
# —Ç–æ 100 —Å–æ–æ–±—â–µ–Ω–∏–π = 100 —Å–µ–∫—É–Ω–¥ < 300 —Å–µ–∫—É–Ω–¥ (max.poll.interval.ms)
# Rebalancing –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–Ω–∏–º–∞–µ—Ç > 5 —Å–µ–∫—É–Ω–¥ ‚Üí —É–º–µ–Ω—å—à–∏—Ç–µ `max.poll.records`
- –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ < 1 —Å–µ–∫—É–Ω–¥—ã ‚Üí —É–≤–µ–ª–∏—á—å—Ç–µ `max.poll.records` –¥–ª—è throughput
- –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è > 5 –º–∏–Ω—É—Ç ‚Üí —É–≤–µ–ª–∏—á—å—Ç–µ `max.poll.interval.ms` (–Ω–æ –Ω–µ –±–æ–ª–µ–µ 30 –º–∏–Ω—É—Ç)

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** Offload —Ç—è–∂–µ–ª–æ–π —Ä–∞–±–æ—Ç—ã –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (Celery, RQ), –∞ consumer —Ç–æ–ª—å–∫–æ –∫–ª–∞–¥–µ—Ç –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å.

---

## –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞: Resilient Consumer

–°–æ–∑–¥–∞–π—Ç–µ production-ready consumer —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –∏ at-least-once —Å–µ–º–∞–Ω—Ç–∏–∫–æ–π.

### –ó–∞–¥–∞–Ω–∏–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ JupyterLab: **http://localhost:8888**
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π notebook
3. –†–µ–∞–ª–∏–∑—É–π—Ç–µ consumer —Å:
   - At-least-once —Å–µ–º–∞–Ω—Ç–∏–∫–æ–π (`enable.auto.offset.store=False`)
   - –û–±—Ä–∞–±–æ—Ç–∫–æ–π fatal/non-fatal –æ—à–∏–±–æ–∫
   - Graceful shutdown (KeyboardInterrupt)
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å:
   - –ó–∞–ø—É—Å—Ç–∏—Ç–µ consumer
   - –í–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Kafka: `docker compose stop kafka`
   - –ù–∞–±–ª—é–¥–∞–π—Ç–µ non-fatal –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö
   - –ó–∞–ø—É—Å—Ç–∏—Ç–µ Kafka: `docker compose start kafka`
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ consumer –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –®–∞–±–ª–æ–Ω —Ä–µ—à–µ–Ω–∏—è

```python
from confluent_kafka import Consumer, KafkaException, KafkaError
import json

# ==============================================================================
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: At-Least-Once —Å manual offset store
# ==============================================================================
config = {
    'bootstrap.servers': 'kafka:9092',
    'group.id': 'resilient-consumer-lab',
    'auto.offset.reset': 'earliest',
    'enable.auto.commit': True,
    'enable.auto.offset.store': False,  # Manual offset store
    'max.poll.records': 50              # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ batch size
}

consumer = Consumer(config)
consumer.subscribe(['dbserver1.public.orders'])

print("=" * 70)
print("Resilient Consumer –∑–∞–ø—É—â–µ–Ω")
print("–¢–æ–ø–∏–∫: dbserver1.public.orders")
print("–°–µ–º–∞–Ω—Ç–∏–∫–∞: At-Least-Once")
print("=" * 70)
print("\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Kafka –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:")
print("  docker compose stop kafka")
print("–ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—Ä–∞—Ç–Ω–æ:")
print("  docker compose start kafka")
print("\n–ù–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º consumer –ø—Ä–∏ —Å–±–æ—è—Ö\n")

processed_count = 0

try:
    while True:
        msg = consumer.poll(timeout=1.0)

        if msg is None:
            continue

        # ==============================================================================
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        # ==============================================================================
        if msg.error():
            error_code = msg.error().code()

            # Non-fatal: –∫–æ–Ω–µ—Ü —Ä–∞–∑–¥–µ–ª–∞
            if error_code == KafkaError._PARTITION_EOF:
                continue

            # Fatal errors
            if msg.error().fatal():
                print(f"\n‚ùå FATAL ERROR: {msg.error()}")
                print("Consumer –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏")
                raise KafkaException(msg.error())

            # Non-fatal errors (—Å–µ—Ç–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ç.–¥.)
            print(f"‚ö†Ô∏è  Non-fatal error: {msg.error()}")
            continue

        # ==============================================================================
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        # ==============================================================================
        try:
            event = json.loads(msg.value().decode('utf-8'))
            payload = event.get('payload', {})
            op = payload.get('op', '?')

            # –ò–º–∏—Ç–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –∑–∞–ø–∏—Å—å –≤ –ë–î, –≤—ã–∑–æ–≤ API –∏ —Ç.–¥.
            processed_count += 1
            print(f"[{processed_count}] –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: op={op}")

            # –í–ê–ñ–ù–û: offset —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
            consumer.store_offsets(msg)

        except Exception as e:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å - offset –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
            # –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ consumer –ø–æ–≤—Ç–æ—Ä–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            print(f"‚ùå Processing error: {e}")
            continue

except KeyboardInterrupt:
    print("\n\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏")
finally:
    print(f"–í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {processed_count} —Å–æ–æ–±—â–µ–Ω–∏–π")
    print("–ó–∞–∫—Ä—ã—Ç–∏–µ consumer...")
    consumer.close()
    print("‚úÖ Consumer –∑–∞–∫—Ä—ã—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

**–®–∞–≥ 1: –ó–∞–ø—É—Å—Ç–∏—Ç–µ consumer –≤ JupyterLab**

**–®–∞–≥ 2: –í –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å–æ–±—ã—Ç–∏—è**

```bash
cd labs/
docker compose exec postgres psql -U postgres -d inventory -c "
INSERT INTO orders (customer_id, product_id, quantity)
SELECT 1, 1, 1 FROM generate_series(1, 20);
"
```

**–®–∞–≥ 3: –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Kafka –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã**

```bash
docker compose stop kafka
```

–ù–∞–±–ª—é–¥–∞–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –≤ consumer. Consumer –Ω–µ –∫—Ä–∞—à–∏—Ç—Å—è, –∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç retry.

**–®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç–µ Kafka –æ–±—Ä–∞—Ç–Ω–æ**

```bash
docker compose start kafka
```

Consumer –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ offset.

---

## –ß—Ç–æ –º—ã —É–∑–Ω–∞–ª–∏

1. **At-Least-Once —Å–µ–º–∞–Ω—Ç–∏–∫–∞:** `enable.auto.offset.store=False` + `consumer.store_offsets()` –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
2. **Exactly-Once —Å–µ–º–∞–Ω—Ç–∏–∫–∞:** Transactional API —Å `isolation.level=read_committed`
3. **Fatal vs Non-Fatal –æ—à–∏–±–∫–∏:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `msg.error().fatal()` –¥–ª—è —Ä–∞–∑–ª–∏—á–µ–Ω–∏—è
4. **Rebalancing:** –£–ø—Ä–∞–≤–ª—è–π—Ç–µ —á–µ—Ä–µ–∑ `max.poll.interval.ms` –∏ `max.poll.records`
5. **Production-ready:** Resilient consumer –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–±–æ—è—Ö

## –ß—Ç–æ –¥–∞–ª—å—à–µ?

–í —Å–ª–µ–¥—É—é—â–µ–º —É—Ä–æ–∫–µ –º—ã –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ–º CDC —Å–æ–±—ã—Ç–∏—è —Å **Pandas DataFrame** –¥–ª—è batch –∞–Ω–∞–ª–∏–∑–∞ –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π.
