---
title: "Outbox Pattern: –¢–µ–æ—Ä–∏—è –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞"
description: "–ù–∞–¥–µ–∂–Ω—ã–π –æ–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞—Ö —á–µ—Ä–µ–∑ transactional outbox"
order: 5
difficulty: "intermediate"
estimatedTime: 30
topics: ["outbox", "microservices", "patterns", "transactions"]
prerequisites: ["module-4/04-content-based-routing"]
---

import { Mermaid } from '../../../components/Mermaid.tsx';

# Outbox Pattern: –¢–µ–æ—Ä–∏—è –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–í—ã —Å—Ç—Ä–æ–∏—Ç–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É. –°–µ—Ä–≤–∏—Å Orders –æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–∫–∞–∑ –∏ –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ Kafka –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ downstream-—Å–µ—Ä–≤–∏—Å–∞–º–∏. –ö–∞–∫ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è, –µ—Å–ª–∏ –ë–î-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞?

–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ ‚Äî "–æ–±–Ω–æ–≤–∏—Ç—å –ë–î, –∑–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Kafka" ‚Äî **–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ**. –≠—Ç–æ dual-write problem, –∏ –æ–Ω –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ data loss –∏ inconsistency –≤ production.

**Outbox Pattern** ‚Äî –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è reliable event publishing –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞—Ö. –í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã —Ä–∞–∑–±–µ—Ä–µ–º —Ç–µ–æ—Ä–∏—é –ø–∞—Ç—Ç–µ—Ä–Ω–∞, –ø–æ—á–µ–º—É –æ–Ω –Ω—É–∂–µ–Ω, –∏ –∫–∞–∫–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏ –æ–Ω –¥–∞–µ—Ç (–∏ –ù–ï –¥–∞–µ—Ç).

## The Dual-Write Problem

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Ç–∏–ø–∏—á–Ω—ã–π –∫–æ–¥ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞:

```python
# –û–ø–∞—Å–Ω—ã–π –∫–æ–¥ - dual-write antipattern
def approve_order(order_id):
    # –®–∞–≥ 1: –û–±–Ω–æ–≤–ª—è–µ–º –ë–î
    db.execute("UPDATE orders SET status = 'APPROVED' WHERE id = %s", order_id)
    db.commit()

    # –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ Kafka
    kafka_producer.send('order-events', {
        'event': 'OrderApproved',
        'orderId': order_id
    })
```

**–ß—Ç–æ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫?**

<Mermaid chart={`
flowchart TB
    START["approve_order(123)"] --> DB["UPDATE orders<br/>SET status = 'APPROVED'"]
    DB --> COMMIT["COMMIT"]
    COMMIT --> KAFKA["kafka_producer.send(...)"]

    KAFKA --> OK{"Success?"}

    OK -->|"YES"| SUCCESS["‚úÖ –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω–∞<br/>‚úÖ –°–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ<br/>Consistency OK"]
    OK -->|"NO"| FAIL["‚úÖ –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω–∞<br/>‚ùå –°–æ–±—ã—Ç–∏–µ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ<br/>üí• Data loss!"]

    style SUCCESS fill:#10b981
    style FAIL fill:#ef4444
    style KAFKA fill:#f59e0b
`} client:visible />

**–ü—Ä–æ–±–ª–µ–º—ã:**

1. **Network failure –º–µ–∂–¥—É COMMIT –∏ send()** ‚Äî –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω–∞, Kafka –Ω–µ –ø–æ–ª—É—á–∏–ª —Å–æ–±—ã—Ç–∏–µ
2. **Kafka –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω** ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞, —Å–æ–±—ã—Ç–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ
3. **Application crash –ø–æ—Å–ª–µ COMMIT** ‚Äî downstream —Å–∏—Å—Ç–µ–º—ã –Ω–µ —É–∑–Ω–∞—é—Ç –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏
4. **Retry –ª–æ–≥–∏–∫–∞ —Å–ª–æ–∂–Ω–∞** ‚Äî –Ω—É–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å, –∫–∞–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–∏–ª–∏, –∞ –∫–∞–∫–∏–µ –Ω–µ—Ç

> **Production –∏—Å—Ç–∏–Ω–∞:** –ï—Å–ª–∏ —É –≤–∞—Å –¥–≤–∞ independent write operations (–ë–î –∏ message broker), –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö –º–æ–∂–µ—Ç fail–∏—Ç—å. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (2PC) —Ä–µ—à–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—É, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω—ã –∏ —Å–ª–æ–∂–Ω—ã –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

**Dual-write = –¥–≤–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö write, –æ–¥–∏–Ω –º–æ–∂–µ—Ç fail–∏—Ç—å.**

## Outbox Pattern: –†–µ—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ CDC

Outbox Pattern –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—É—é –∏–¥–µ—é: **–æ–¥–∏–Ω write operation –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö**.

**–ö–ª—é—á–µ–≤–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è:** –í–º–µ—Å—Ç–æ UPDATE + SEND –¥–µ–ª–∞–µ–º UPDATE + INSERT –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. CDC-—Å–∏—Å—Ç–µ–º–∞ (Debezium) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ outbox-—Ç–∞–±–ª–∏—Ü—ã.

<Mermaid chart={`
flowchart LR
    subgraph APP["Application"]
        direction TB
        BIZ["Business Logic"]
        TX["BEGIN TRANSACTION"]
        UPD["UPDATE orders"]
        INS["INSERT INTO outbox"]
        COMMIT["COMMIT"]

        BIZ --> TX
        TX --> UPD
        UPD --> INS
        INS --> COMMIT
    end

    subgraph DB["PostgreSQL"]
        ORDERS[("orders table")]
        OUTBOX[("outbox table")]
        WAL["Write-Ahead Log"]

        ORDERS -.->|"Atomic write"| WAL
        OUTBOX -.->|"Atomic write"| WAL
    end

    subgraph CDC["Debezium"]
        DBZ["Debezium Connector"]
        SMT["Outbox Event Router SMT"]

        DBZ -->|"Reads WAL"| SMT
    end

    subgraph KAFKA["Apache Kafka"]
        TOPIC["order-events topic"]
    end

    COMMIT -->|"1. Atomic commit"| ORDERS
    COMMIT -->|"1. Atomic commit"| OUTBOX
    WAL -->|"2. CDC capture"| DBZ
    SMT -->|"3. Publish"| TOPIC

    style APP fill:#8b5cf6
    style DB fill:#3b82f6
    style CDC fill:#f59e0b
    style KAFKA fill:#10b981
    style TX fill:#ef4444
`} client:visible />

**–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:**

1. **Application:** UPDATE business data + INSERT outbox event –≤ **–æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**
2. **PostgreSQL:** –ê—Ç–æ–º–∞—Ä–Ω–æ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –æ–±–∞ write –≤ WAL
3. **Debezium:** –ß–∏—Ç–∞–µ—Ç WAL, –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è outbox-—Ç–∞–±–ª–∏—Ü—ã
4. **Outbox Event Router SMT:** –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç CDC event –≤ domain event
5. **Kafka:** –ü–æ–ª—É—á–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –≤ topic

**–ì–∞—Ä–∞–Ω—Ç–∏—è:** –ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ ‚Äî —Å–æ–±—ã—Ç–∏–µ **–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ** –ø–æ–ø–∞–¥–µ—Ç –≤ Kafka (at-least-once).

## Outbox Table Schema

Outbox-—Ç–∞–±–ª–∏—Ü–∞ –∏–º–µ–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –¥–ª—è Event Router SMT.

```sql
CREATE TABLE public.outbox (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    aggregatetype VARCHAR(255) NOT NULL,
    aggregateid VARCHAR(255) NOT NULL,
    type VARCHAR(255) NOT NULL,
    payload JSONB NOT NULL,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW() NOT NULL
);

CREATE INDEX idx_outbox_created ON public.outbox(created_at);

COMMENT ON TABLE public.outbox IS 'Transactional outbox for reliable event publishing via Debezium';
```

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª–µ–π

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------|----------|--------|
| **id** | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ–±—ã—Ç–∏—è | `550e8400-e29b-41d4-a716-446655440000` |
| **aggregatetype** | –¢–∏–ø domain entity (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç topic) | `Order`, `Customer`, `Payment` |
| **aggregateid** | ID entity (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ Kafka key) | `order-123` |
| **type** | –¢–∏–ø —Å–æ–±—ã—Ç–∏—è | `OrderCreated`, `OrderApproved`, `OrderCancelled` |
| **payload** | Event data –≤ JSON-—Ñ–æ—Ä–º–∞—Ç–µ | `{"orderId": "123", "amount": 299.99}` |
| **created_at** | Timestamp —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è | `2026-02-01 10:30:15` |

### –ö–∞–∫ SMT –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–∏ –ø–æ–ª—è

**Outbox Event Router SMT** –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç outbox record –≤ domain event:

```
aggregatetype = "Order" ‚Üí Topic: outbox.event.Order
aggregateid = "order-123" ‚Üí Kafka key: "order-123"
type = "OrderApproved" ‚Üí Event header: type = "OrderApproved"
payload = {...} ‚Üí Kafka message value: {...}
id ‚Üí Kafka header: id = "550e8400..."
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Kafka –ø–æ–ª—É—á–∞–µ—Ç clean domain event –±–µ–∑ CDC metadata.

## Application Pattern: Transactional Event Emission

–í–æ—Ç –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –∫–æ–¥ —Å Outbox Pattern:

```python
# –ù–∞–¥–µ–∂–Ω—ã–π –∫–æ–¥ —Å Outbox Pattern
def approve_order(order_id):
    conn = db.get_connection()
    cursor = conn.cursor()

    try:
        # BEGIN TRANSACTION (implicit)

        # –®–∞–≥ 1: Business logic update
        cursor.execute("""
            UPDATE orders
            SET status = 'APPROVED', updated_at = NOW()
            WHERE id = %s
        """, (order_id,))

        # –®–∞–≥ 2: Emit event to outbox (same transaction!)
        cursor.execute("""
            INSERT INTO outbox (id, aggregatetype, aggregateid, type, payload)
            VALUES (gen_random_uuid(), %s, %s, %s, %s)
        """, (
            'Order',                    # aggregatetype
            order_id,                   # aggregateid
            'OrderApproved',            # type
            json.dumps({                # payload
                'orderId': order_id,
                'approvedAt': datetime.now().isoformat(),
                'amount': 299.99
            })
        ))

        # COMMIT - –æ–±–∞ write –∞—Ç–æ–º–∞—Ä–Ω—ã
        conn.commit()

    except Exception as e:
        conn.rollback()
        raise
```

**–ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ:** –°–æ–±—ã—Ç–∏—è –ø—É–±–ª–∏–∫—É—é—Ç—Å—è —á–µ—Ä–µ–∑ INSERT, –∞ –Ω–µ —á–µ—Ä–µ–∑ Kafka producer API.

### –° cleanup'–æ–º outbox-—Ç–∞–±–ª–∏—Ü—ã

–ß—Ç–æ–±—ã outbox –Ω–µ —Ä–æ—Å indefinitely, –º–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Å–æ–±—ã—Ç–∏—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ INSERT:

```python
# Emit event + cleanup –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
cursor.execute("""
    WITH inserted AS (
        INSERT INTO outbox (id, aggregatetype, aggregateid, type, payload)
        VALUES (gen_random_uuid(), %s, %s, %s, %s)
        RETURNING id
    )
    DELETE FROM outbox WHERE id = (SELECT id FROM inserted)
""", ('Order', order_id, 'OrderApproved', json.dumps({...})))

conn.commit()
```

> **–í–∞–∂–Ω–æ:** Debezium –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç INSERT **–¥–æ** DELETE. DELETE-—Å–æ–±—ã—Ç–∏–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è Outbox Event Router –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —Ç–∞–∫ —á—Ç–æ cleanup –±–µ–∑–æ–ø–∞—Å–µ–Ω.

## Guarantees –∏ Limitations

Outbox Pattern ‚Äî –Ω–µ magic. –í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å, —á—Ç–æ –æ–Ω –¥–∞–µ—Ç, –∞ —á—Ç–æ –Ω–µ—Ç.

### ‚úÖ –ß—Ç–æ Outbox –ì–ê–†–ê–ù–¢–ò–†–£–ï–¢

| Guarantee | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| **Atomicity (single-database)** | UPDATE + INSERT outbox –∞—Ç–æ–º–∞—Ä–Ω—ã (–ª–∏–±–æ –æ–±–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã, –ª–∏–±–æ –æ–±–∞ –æ—Ç–∫–∞—á–µ–Ω—ã) |
| **At-least-once delivery** | –ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ ‚Üí —Å–æ–±—ã—Ç–∏–µ –ø–æ–ø–∞–¥–µ—Ç –≤ Kafka (–º–æ–∂–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ retry) |
| **Ordering per aggregate** | –°–æ–±—ã—Ç–∏—è –æ–¥–Ω–æ–≥–æ aggregateid –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ (Kafka partition key = aggregateid) |
| **Durability** | –°–æ–±—ã—Ç–∏—è –≤ WAL, –ø–µ—Ä–µ–∂–µ–≤—É—Ç crash –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ Debezium |

### ‚ùå –ß—Ç–æ Outbox –ù–ï –ì–ê–†–ê–ù–¢–ò–†–£–ï–¢

| Limitation | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| **Exactly-once delivery** | –°–æ–±—ã—Ç–∏—è –º–æ–≥—É—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ Debezium retry. Consumers –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å idempotent |
| **Distributed ACID** | Outbox –ù–ï –¥–∞–µ—Ç ACID-–≥–∞—Ä–∞–Ω—Ç–∏–∏ –º–µ–∂–¥—É –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏ (eventual consistency, –Ω–µ immediate) |
| **Cross-service rollback** | –ï—Å–ª–∏ downstream-—Å–µ—Ä–≤–∏—Å fail–Ω—É–ª—Å—è, upstream-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ù–ï –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è |
| **Immediate consistency** | –ï—Å—Ç—å lag –º–µ–∂–¥—É COMMIT –∏ –ø–æ—è–≤–ª–µ–Ω–∏–µ–º —Å–æ–±—ã—Ç–∏—è –≤ Kafka (–æ–±—ã—á–Ω–æ <1 —Å–µ–∫—É–Ω–¥—ã, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –ø—Ä–∏ backpressure) |

> **Critical callout:** Outbox Pattern ‚Äî —ç—Ç–æ –ù–ï distributed transactions. –≠—Ç–æ **reliable messaging** —Å eventual consistency. –ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–µ–Ω distributed ACID ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Saga pattern –∏–ª–∏ 2PC (–Ω–æ –≥–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏).

### –ß—Ç–æ —Ç–∞–∫–æ–µ At-Least-Once Delivery?

**At-least-once** –æ–∑–Ω–∞—á–∞–µ—Ç: —Å–æ–±—ã—Ç–∏–µ –¥–æ—Å—Ç–∞–≤–∏—Ç—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–∞–∑, –≤–æ–∑–º–æ–∂–Ω–æ –±–æ–ª—å—à–µ.

<Mermaid chart={`
flowchart LR
    subgraph SCENARIO1["–ù–æ—Ä–º–∞–ª—å–Ω—ã–π flow"]
        A1["INSERT outbox"] --> B1["Debezium —á–∏—Ç–∞–µ—Ç"] --> C1["Kafka receives"] --> D1["Debezium offset commit"]
    end

    subgraph SCENARIO2["Retry scenario"]
        A2["INSERT outbox"] --> B2["Debezium —á–∏—Ç–∞–µ—Ç"] --> C2["Kafka receives"] --> D2["Debezium crash<br/>(offset –Ω–µ committed)"]
        D2 --> E2["Debezium restart"] --> F2["Reads SAME event"] --> G2["Kafka receives AGAIN"]
    end

    style SCENARIO1 fill:#10b981
    style SCENARIO2 fill:#f59e0b
`} client:visible />

**–°–ª–µ–¥—Å—Ç–≤–∏–µ:** Consumers –¥–æ–ª–∂–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å duplicate events idempotently.

```python
# Consumer MUST be idempotent
def handle_order_approved(event):
    order_id = event['orderId']
    event_id = event.headers['id']  # Outbox event ID

    # Deduplication check
    if already_processed(event_id):
        print(f"Event {event_id} already processed, skipping")
        return

    # Process event
    send_approval_email(order_id)

    # Mark as processed
    mark_processed(event_id)
```

## Outbox Cleanup Strategies

Outbox-—Ç–∞–±–ª–∏—Ü–∞ –º–æ–∂–µ—Ç —Ä–∞—Å—Ç–∏ indefinitely, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª—è—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è.

### Strategy 1: DELETE –≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —É—á–µ–±–Ω—ã—Ö —Ü–µ–ª–µ–π)

```sql
BEGIN;
UPDATE orders SET status = 'APPROVED' WHERE id = '123';
INSERT INTO outbox (...) VALUES (...);
DELETE FROM outbox WHERE id = '<just-inserted-id>';  -- Cleanup —Å—Ä–∞–∑—É
COMMIT;
```

**–ü–ª—é—Å—ã:**
- –ü—Ä–æ—Å—Ç–æ—Ç–∞
- Outbox –≤—Å–µ–≥–¥–∞ "–ø—É—Å—Ç–∞—è"
- –ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

**–ú–∏–Ω—É—Å—ã:**
- DELETE —Ç–∞–∫–∂–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç WAL (overhead)
- Debezium –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç DELETE –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (OK –¥–ª—è –Ω–∞—Å)

### Strategy 2: External Cleanup Job (production –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)

```sql
-- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π cleanup (cron job, scheduled task)
DELETE FROM outbox
WHERE created_at < NOW() - INTERVAL '1 hour';
```

**–ü–ª—é—Å—ã:**
- –ú–µ–Ω—å—à–µ WAL overhead –≤ hot path
- –ú–æ–∂–Ω–æ batch —É–¥–∞–ª—è—Ç—å —Å–æ–±—ã—Ç–∏—è

**–ú–∏–Ω—É—Å—ã:**
- –†–∏—Å–∫ lock contention —Å INSERTs
- –ù—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å

> **Recommendation –¥–ª—è –∫—É—Ä—Å–∞:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Strategy 1 (DELETE –≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏) –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã. –í production –æ—Ü–µ–Ω–∏—Ç–µ volume –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é.

## –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Outbox Pattern?

### ‚úÖ Use Cases –¥–ª—è Outbox

- **Microservices event publishing:** –°–µ—Ä–≤–∏—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –∏ –¥–æ–ª–∂–µ–Ω —É–≤–µ–¥–æ–º–∏—Ç—å –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã
- **CQRS (Command Query Responsibility Segregation):** Write model —ç–º–∏—Ç–∏—Ç —Å–æ–±—ã—Ç–∏—è –¥–ª—è Read model
- **Event Sourcing integration:** –°–æ–±—ã—Ç–∏—è –∏–∑ –ë–î –ø–æ–ø–∞–¥–∞—é—Ç –≤ event stream
- **Audit trail:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –±–∏–∑–Ω–µ—Å-—Å–æ–±—ã—Ç–∏–π

### ‚ùå –ö–æ–≥–¥–∞ Outbox –∏–∑–±—ã—Ç–æ—á–µ–Ω

- **Request-response communication:** –ï—Å–ª–∏ downstream —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –æ—Ç–≤–µ—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ REST/gRPC
- **Low-value events:** –ï—Å–ª–∏ –ø–æ—Ç–µ—Ä—è —Å–æ–±—ã—Ç–∏—è –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ direct Kafka send
- **Single database, no downstream systems:** –ï—Å–ª–∏ –Ω–µ—Ç –≤–Ω–µ—à–Ω–∏—Ö –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π ‚Äî Outbox –Ω–µ –Ω—É–∂–µ–Ω

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞: Microservices —Å Outbox

<Mermaid chart={`
flowchart TB
    subgraph ORDER_SERVICE["Order Service"]
        ORDER_API["REST API"]
        ORDER_DB[("PostgreSQL<br/>orders + outbox")]
        ORDER_API -->|"UPDATE + INSERT outbox"| ORDER_DB
    end

    subgraph PAYMENT_SERVICE["Payment Service"]
        PAYMENT_API["REST API"]
        PAYMENT_DB[("PostgreSQL<br/>payments + outbox")]
        PAYMENT_API -->|"UPDATE + INSERT outbox"| PAYMENT_DB
    end

    subgraph CDC["CDC Infrastructure"]
        DBZ_ORDER["Debezium Connector<br/>(Order Service)"]
        DBZ_PAYMENT["Debezium Connector<br/>(Payment Service)"]
    end

    subgraph KAFKA["Apache Kafka"]
        TOPIC_ORDER["outbox.event.Order"]
        TOPIC_PAYMENT["outbox.event.Payment"]
    end

    subgraph NOTIFICATION["Notification Service"]
        CONSUMER["Kafka Consumer"]
        CONSUMER_DB[("PostgreSQL<br/>notifications")]
        CONSUMER --> CONSUMER_DB
    end

    ORDER_DB -->|"CDC capture"| DBZ_ORDER
    PAYMENT_DB -->|"CDC capture"| DBZ_PAYMENT

    DBZ_ORDER -->|"Publish"| TOPIC_ORDER
    DBZ_PAYMENT -->|"Publish"| TOPIC_PAYMENT

    TOPIC_ORDER --> CONSUMER
    TOPIC_PAYMENT --> CONSUMER

    style ORDER_SERVICE fill:#8b5cf6
    style PAYMENT_SERVICE fill:#3b82f6
    style CDC fill:#f59e0b
    style KAFKA fill:#10b981
    style NOTIFICATION fill:#ec4899
`} client:visible />

**Flow:**
1. Order Service –æ–±–Ω–æ–≤–ª—è–µ—Ç orders + INSERT –≤ outbox (–∞—Ç–æ–º–∞—Ä–Ω–æ)
2. Payment Service –æ–±–Ω–æ–≤–ª—è–µ—Ç payments + INSERT –≤ outbox (–∞—Ç–æ–º–∞—Ä–Ω–æ)
3. Debezium connectors –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—Ç outbox events –∏–∑ –∫–∞–∂–¥–æ–π –ë–î
4. –°–æ–±—ã—Ç–∏—è –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤ Kafka topics
5. Notification Service –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**Eventual consistency:** Order Service –Ω–µ –∑–Ω–∞–µ—Ç, —É—Å–ø–µ—à–Ω–æ –ª–∏ Notification Service –æ–±—Ä–∞–±–æ—Ç–∞–ª —Å–æ–±—ã—Ç–∏–µ. –≠—Ç–æ trade-off –¥–ª—è decoupling.

## –ß—Ç–æ –¥–∞–ª—å—à–µ?

–í—ã –ø–æ–Ω—è–ª–∏ —Ç–µ–æ—Ä–∏—é Outbox Pattern. –¢–µ–ø–µ—Ä—å –∫–ª—é—á–µ–≤–æ–π –≤–æ–ø—Ä–æ—Å: **–∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Debezium Outbox Event Router SMT?**

–í —Å–ª–µ–¥—É—é—â–µ–º —É—Ä–æ–∫–µ –º—ã:
- –°–æ–∑–¥–∞–¥–∏–º outbox-—Ç–∞–±–ª–∏—Ü—É –≤ PostgreSQL
- –ù–∞—Å—Ç—Ä–æ–∏–º Debezium connector —Å Outbox Event Router SMT
- –ù–∞–ø–∏—à–µ–º application code –¥–ª—è event emission
- –†–µ–∞–ª–∏–∑—É–µ–º idempotent consumer –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π

## –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

1. **Dual-write problem:** UPDATE –ë–î + SEND Kafka = –¥–≤–∞ independent writes, –æ–¥–∏–Ω –º–æ–∂–µ—Ç fail–∏—Ç—å
2. **Outbox solution:** UPDATE + INSERT outbox –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, CDC –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏—è
3. **At-least-once delivery:** –°–æ–±—ã—Ç–∏—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è, –Ω–æ –º–æ–≥—É—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è
4. **NOT distributed ACID:** Outbox –¥–∞–µ—Ç eventual consistency, –Ω–µ immediate consistency
5. **Idempotency required:** Consumers –¥–æ–ª–∂–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å duplicate events
6. **Cleanup strategies:** DELETE –≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–ø—Ä–æ—Å—Ç–æ—Ç–∞) –∏–ª–∏ external job (production scale)
7. **Use case:** Microservices event publishing, CQRS, Event Sourcing integration
8. **Schema:** id, aggregatetype, aggregateid, type, payload ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è Event Router SMT
