---
title: "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å gh-ost –∏ pt-online-schema-change"
description: "–ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –æ–Ω–ª–∞–π–Ω-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ DDL —Å Debezium MySQL CDC: gh-ost –∏ pt-online-schema-change –¥–ª—è zero-downtime –º–∏–≥—Ä–∞—Ü–∏–π —Å—Ö–µ–º"
order: 15
difficulty: "advanced"
estimatedTime: 35
topics: ["mysql", "debezium", "ddl", "gh-ost", "pt-osc", "schema-migration"]
prerequisites: ["module-8/01-binlog-architecture", "module-8/06-schema-history-recovery"]
---

import { GhOstFlowDiagram, PtOscFlowDiagram, DdlToolComparisonDiagram, GhostTableLifecycleDiagram } from '../../../components/diagrams/module3/DdlToolsDiagrams';
import Callout from '../../../components/Callout.tsx';

# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å gh-ost –∏ pt-online-schema-change

–í production-–æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ `ALTER TABLE` –Ω–∞ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö ‚Äî —ç—Ç–æ —Ä–∏—Å–∫. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `ALTER TABLE` –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç downtime –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏. –î–ª—è —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ 100GB —ç—Ç–æ –º–æ–≥—É—Ç –±—ã—Ç—å —á–∞—Å—ã.

**–û–Ω–ª–∞–π–Ω-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã DDL** (gh-ost, pt-online-schema-change) —Ä–µ—à–∞—é—Ç —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É, –≤—ã–ø–æ–ª–Ω—è—è schema migrations –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã. –ù–æ –æ–Ω–∏ —Å–æ–∑–¥–∞—é—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ helper-—Ç–∞–±–ª–∏—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ Debezium –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤ binlog. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —ç—Ç–∏—Ö —Ç–∞–±–ª–∏—Ü –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö –≤ CDC-–ø–∞–π–ø–ª–∞–π–Ω–µ –∏–ª–∏ –ø–∞–¥–µ–Ω–∏—é –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞.

–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã –∏–∑—É—á–∏–º, –∫–∞–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å gh-ost –∏ pt-online-schema-change —Å Debezium MySQL CDC, –Ω–∞—Å—Ç—Ä–æ–∏–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é helper-—Ç–∞–±–ª–∏—Ü –∏ —Ä–∞–∑–±–µ—Ä—ë–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è zero-downtime DDL –º–∏–≥—Ä–∞—Ü–∏–π.

## –ü—Ä–æ–±–ª–µ–º–∞ DDL –≤ CDC-–æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö

### Standard ALTER TABLE: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏ downtime

```sql
-- –ü—Ä–æ—Å—Ç–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏
ALTER TABLE orders ADD COLUMN status VARCHAR(20);
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ MySQL:**

1. **–°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã** —Å –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π
2. **–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫** –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
3. **Table lock** ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É
4. **Rename** ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∑–∞–º–µ–Ω—è–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é

<GhostTableLifecycleDiagram client:visible />

**–ü—Ä–æ–±–ª–µ–º—ã:**

- **Downtime:** –î–ª—è —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ 100GB ‚Äî 1-2 —á–∞—Å–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- **Replication lag:** Slave —Ä–µ–ø–ª–∏–∫–∏ –æ—Ç—Å—Ç–∞—é—Ç –Ω–∞ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏
- **Binlog flood:** –û–≥—Ä–æ–º–Ω—ã–π –æ–±—ä—ë–º —Å–æ–±—ã—Ç–∏–π –∑–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è
- **Application errors:** Timeout, connection pool exhaustion

<Callout type="danger">
**Production incident: ALTER TABLE –Ω–∞ 500GB —Ç–∞–±–ª–∏—Ü–µ**

–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—É—Å—Ç–∏–ª `ALTER TABLE` –≤ production –±–µ–∑ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è. –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–Ω—è–ª–∞ 6 —á–∞—Å–æ–≤. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—ã–ª–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤—Å—ë —ç—Ç–æ –≤—Ä–µ–º—è. –ò—Ç–æ–≥: $500K –ø–æ—Ç–µ—Ä—å –≤—ã—Ä—É—á–∫–∏, —É–≤–æ–ª—å–Ω–µ–Ω–∏–µ.

**–£—Ä–æ–∫:** –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–Ω–ª–∞–π–Ω-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã DDL –¥–ª—è —Ç–∞–±–ª–∏—Ü >10GB –≤ production.
</Callout>

### Online DDL: zero-downtime –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞

–û–Ω–ª–∞–π–Ω-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã DDL –≤—ã–ø–æ–ª–Ω—è—é—Ç –º–∏–≥—Ä–∞—Ü–∏—é **–±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏** —Ç–∞–±–ª–∏—Ü—ã:

1. **–°–æ–∑–¥–∞—é—Ç –∫–æ–ø–∏—é —Ç–∞–±–ª–∏—Ü—ã** —Å –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π (ghost/helper table)
2. **–ö–æ–ø–∏—Ä—É—é—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ—Ä—Ü–∏—è–º–∏** (chunked copy)
3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è** –≤–æ –≤—Ä–µ–º—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
4. **–ê—Ç–æ–º–∞—Ä–Ω—ã–π rename** –≤ –∫–æ–Ω—Ü–µ (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ, users –Ω–µ –∑–∞–º–µ—á–∞—é—Ç –º–∏–≥—Ä–∞—Ü–∏—é.

## –û–Ω–ª–∞–π–Ω-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã DDL: gh-ost vs pt-osc

### gh-ost (GitHub Online Schema Change Tool)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** Triggerless, –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ —á—Ç–µ–Ω–∏–∏ binlog.

<GhOstFlowDiagram client:visible />

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**

1. **–°–æ–∑–¥–∞—ë—Ç `_orders_gho`** (ghost table) —Å –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π
2. **–°–æ–∑–¥–∞—ë—Ç `_orders_ghc`** (changelog table) –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–∏
3. **–ö–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ** –∏–∑ `orders` –≤ `_orders_gho` –ø–æ—Ä—Ü–∏—è–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1000 —Å—Ç—Ä–æ–∫)
4. **–ß–∏—Ç–∞–µ—Ç binlog** –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º
5. **–ü—Ä–∏–º–µ–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è** –∏–∑ binlog –∫ ghost table
6. **–ê—Ç–æ–º–∞—Ä–Ω—ã–π rename** –≤ –∫–æ–Ω—Ü–µ: `orders` ‚Üî `_orders_gho`

**–ü—Ä–∏–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã:**

```bash
gh-ost \
  --host=mysql \
  --user=gh-ost \
  --password=ghp \
  --database=mydb \
  --table=orders \
  --alter="ADD COLUMN status VARCHAR(20)" \
  --assume-rbr \
  --allow-on-master \
  --exact-rowcount \
  --concurrent-rowcount \
  --chunk-size=1000 \
  --max-load=Threads_running=25 \
  --critical-load=Threads_running=50 \
  --default-retries=120 \
  --execute
```

**–ü–ª—é—Å—ã:**

- ‚úÖ Triggerless ‚Äî –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç overhead –Ω–∞ –∫–∞–∂–¥—É—é –∑–∞–ø–∏—Å—å
- ‚úÖ Throttling ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
- ‚úÖ Replica-aware ‚Äî –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å binlog —Å —Ä–µ–ø–ª–∏–∫–∏
- ‚úÖ Pausable ‚Äî –º–æ–∂–Ω–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å

**–ú–∏–Ω—É—Å—ã:**

- ‚ùå **–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç foreign keys** (–Ω—É–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ —É–¥–∞–ª–∏—Ç—å)
- ‚ùå –ß–∏—Ç–∞–µ—Ç —Ç–æ—Ç –∂–µ binlog, —á—Ç–æ –∏ Debezium (—É–¥–≤–æ–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞)
- ‚ùå –¢—Ä–µ–±—É–µ—Ç binlog format ROW

### pt-online-schema-change (Percona Toolkit)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** Trigger-based.

<PtOscFlowDiagram client:visible />

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**

1. **–°–æ–∑–¥–∞—ë—Ç `_orders_new`** —Å –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π
2. **–°–æ–∑–¥–∞—ë—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã** –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ (INSERT/UPDATE/DELETE)
3. **–ö–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ** –∏–∑ `orders` –≤ `_orders_new` –ø–æ—Ä—Ü–∏—è–º–∏
4. **–¢—Ä–∏–≥–≥–µ—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
5. **–ê—Ç–æ–º–∞—Ä–Ω—ã–π rename** –≤ –∫–æ–Ω—Ü–µ: `orders` ‚Üí `_orders_old`, `_orders_new` ‚Üí `orders`
6. **–£–¥–∞–ª—è–µ—Ç `_orders_old`**

**–ü—Ä–∏–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã:**

```bash
pt-online-schema-change \
  --alter="ADD COLUMN status VARCHAR(20)" \
  --execute \
  --chunk-size=1000 \
  --max-load=Threads_running:25 \
  --critical-load=Threads_running:50 \
  h=mysql,u=pt-osc,p=ptp,D=mydb,t=orders
```

**–ü–ª—é—Å—ã:**

- ‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç foreign keys** (—á–µ—Ä–µ–∑ trigger cascade)
- ‚úÖ –ù–µ —á–∏—Ç–∞–µ—Ç binlog (–º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ binlog)
- ‚úÖ –ü—Ä–æ—â–µ –≤ –æ—Ç–ª–∞–¥–∫–µ (triggers –≤–∏–¥–Ω—ã –≤ MySQL)

**–ú–∏–Ω—É—Å—ã:**

- ‚ùå Trigger overhead ‚Äî –∫–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å –≤—ã–∑—ã–≤–∞–µ—Ç 3 —Ç—Ä–∏–≥–≥–µ—Ä–∞
- ‚ùå –ù–µ–ª—å–∑—è –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
- ‚ùå Triggers —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç binlog —Ä–∞–∑–º–µ—Ä

### –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞: gh-ost vs pt-osc

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | gh-ost | pt-online-schema-change |
|----------------|--------|-------------------------|
| **–ú–µ—Ö–∞–Ω–∏–∑–º** | Binlog reading | Triggers |
| **Helper tables** | `_gho`, `_ghc` | `_new`, `_old` |
| **Foreign keys** | ‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç | ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç |
| **Binlog impact** | –£–¥–≤–æ–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (—á–∏—Ç–∞–µ—Ç + –ø–∏—à–µ—Ç) | –ù–æ—Ä–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ |
| **CDC event volume** | –í—ã—à–µ (—Å–æ–±—ã—Ç–∏—è –æ—Ç ghost table) | –ù–∏–∂–µ (—Ç–æ–ª—å–∫–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞) |
| **Throttling** | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π, replica-aware | –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ |
| **Pausable** | ‚úÖ –î–∞ | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ |
| **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è CDC** | –ï—Å–ª–∏ –Ω–µ—Ç FK –∏ Debezium —á–∏—Ç–∞–µ—Ç —Ä–µ–ø–ª–∏–∫—É | –ï—Å–ª–∏ –µ—Å—Ç—å FK –∏–ª–∏ –Ω—É–∂–Ω–∞ –º–µ–Ω—å—à–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ |

<Callout type="warning">
**gh-ost —É–¥–≤–∞–∏–≤–∞–µ—Ç binlog read –Ω–∞–≥—Ä—É–∑–∫—É**

–í–æ –≤—Ä–µ–º—è gh-ost –º–∏–≥—Ä–∞—Ü–∏–∏:
- gh-ost —á–∏—Ç–∞–µ—Ç binlog (–¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- Debezium —á–∏—Ç–∞–µ—Ç binlog (–¥–ª—è CDC)

–ï—Å–ª–∏ –æ–±–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ —á–∏—Ç–∞—é—Ç —Å –æ–¥–Ω–æ–≥–æ master —Å–µ—Ä–≤–µ—Ä–∞, binlog I/O —É–¥–≤–∞–∏–≤–∞–µ—Ç—Å—è. –í AWS Aurora —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —á–∏—Ç–∞—Ç—å —Å reader instance.
</Callout>

## –ü—Ä–æ–±–ª–µ–º–∞ Helper Tables –≤ CDC

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –±–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: Helper tables –ù–ï –≤ table.include.list**

```json
{
  "name": "mysql-connector",
  "config": {
    "table.include.list": "mydb.orders,mydb.users",
    ...
  }
}
```

**–ó–∞–ø—É—Å–∫–∞–µ–º gh-ost:**

```bash
gh-ost --table=orders --alter="ADD COLUMN status VARCHAR(20)" --execute
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1. gh-ost —Å–æ–∑–¥–∞—ë—Ç `_orders_gho` –∏ `_orders_ghc`
2. Binlog —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–±—ã—Ç–∏—è –¥–ª—è —ç—Ç–∏—Ö —Ç–∞–±–ª–∏—Ü
3. Debezium –≤–∏–¥–∏—Ç —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Ç–∞–±–ª–∏—Ü, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ schema history
4. **ERROR:** `Table _orders_gho not found in schema history topic`
5. **Connector crashes mid-migration** üí•

<Callout type="danger">
**Connector crash –≤–æ –≤—Ä–µ–º—è gh-ost –º–∏–≥—Ä–∞—Ü–∏–∏**

–ï—Å–ª–∏ helper tables –Ω–µ –≤–∫–ª—é—á–µ–Ω—ã –≤ capture pattern, –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä —É–ø–∞–¥—ë—Ç —Å –æ—à–∏–±–∫–æ–π missing table. –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è, –Ω–æ CDC-–ø–∞–π–ø–ª–∞–π–Ω –±—É–¥–µ—Ç —Å–ª–æ–º–∞–Ω –¥–æ —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞.

**–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ:** –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —à–∏—Ä–æ–∫–∏–π capture pattern (`mydb.*`) –∏–ª–∏ —è–≤–Ω–æ –≤–∫–ª—é—á–∞–π—Ç–µ helper tables.
</Callout>

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: Helper tables –≤ table.include.list, –Ω–æ –ù–ï —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è**

```json
{
  "name": "mysql-connector",
  "config": {
    "table.include.list": "mydb.*",
    ...
  }
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1. Debezium –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –æ—Ç `orders`, `_orders_gho`, `_orders_ghc`
2. Kafka –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ø–∏–∫–∏:
   - `mysql-server.mydb.orders`
   - `mysql-server.mydb._orders_gho`
   - `mysql-server.mydb._orders_ghc`
3. Consumers –≤–∏–¥—è—Ç **–¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –¥–∞–Ω–Ω—ã–µ** (—Ç–∞ –∂–µ —Å—Ç—Ä–æ–∫–∞ –∏–∑ `orders` –∏ `_orders_gho`)
4. Downstream —Å–∏—Å—Ç–µ–º—ã –ø—É—Ç–∞—é—Ç—Å—è: –∫–∞–∫–∞—è –≤–µ—Ä—Å–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è?

**–ü—Ä–æ–±–ª–µ–º–∞:** Helper tables ‚Äî —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–∏. Consumers –Ω–µ –¥–æ–ª–∂–Ω—ã –∏—Ö –≤–∏–¥–µ—Ç—å.

## Pattern 1: Broad Capture + SMT Filter (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:**

1. –ó–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã —à–∏—Ä–æ–∫–∏–º –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º (`mydb.*`)
2. –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å helper table —Å–æ–±—ã—Ç–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ Kafka
3. Consumers –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

<DdlToolComparisonDiagram client:visible />

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å Filter SMT

```json
{
  "name": "mysql-connector-with-ddl-tools",
  "config": {
    "connector.class": "io.debezium.connector.mysql.MySqlConnector",
    "database.hostname": "mysql",
    "database.port": "3306",
    "database.user": "debezium",
    "database.password": "dbz",
    "database.server.id": "184001",
    "database.server.name": "mysql-server",

    "table.include.list": "mydb.*",

    "snapshot.mode": "when_needed",
    "schema.history.internal.kafka.topic": "schema-changes.mysql-server",
    "schema.history.internal.kafka.bootstrap.servers": "kafka:9092",

    "transforms": "FilterHelperTables",
    "transforms.FilterHelperTables.type": "io.debezium.transforms.Filter",
    "transforms.FilterHelperTables.language": "jsr223.groovy",
    "transforms.FilterHelperTables.condition": "!value.source.table.matches('.*_(gho|ghc|new|old)$')"
  }
}
```

**–†–∞–∑–±–æ—Ä Filter SMT:**

```groovy
!value.source.table.matches('.*_(gho|ghc|new|old)$')
```

- `value.source.table` ‚Äî –∏–º—è —Ç–∞–±–ª–∏—Ü—ã –∏–∑ Debezium event
- `.matches('...')` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç regex –ø–∞—Ç—Ç–µ—Ä–Ω
- `_gho$` ‚Äî gh-ost ghost table (–Ω–∞–ø—Ä–∏–º–µ—Ä, `_orders_gho`)
- `_ghc$` ‚Äî gh-ost changelog table (–Ω–∞–ø—Ä–∏–º–µ—Ä, `_orders_ghc`)
- `_new$` ‚Äî pt-osc –Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `_orders_new`)
- `_old$` ‚Äî pt-osc —Å—Ç–∞—Ä–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ—Å–ª–µ rename (–Ω–∞–ø—Ä–∏–º–µ—Ä, `_orders_old`)
- `!` ‚Äî –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —É—Å–ª–æ–≤–∏–µ (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è, –ù–ï —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—É)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

- –°–æ–±—ã—Ç–∏—è –æ—Ç `orders` ‚Üí **PASS** (–æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ Kafka)
- –°–æ–±—ã—Ç–∏—è –æ—Ç `_orders_gho` ‚Üí **FILTERED** (–æ—Ç–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è)
- –°–æ–±—ã—Ç–∏—è –æ—Ç `_orders_ghc` ‚Üí **FILTERED** (–æ—Ç–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è)
- –°–æ–±—ã—Ç–∏—è –æ—Ç `_orders_new` ‚Üí **FILTERED** (–æ—Ç–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è)

<Callout type="tip">
**Filter SMT —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–æ Kafka producer**

–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ Debezium connector –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Kafka. –≠—Ç–æ —ç–∫–æ–Ω–æ–º–∏—Ç:
- Kafka storage (–æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è)
- Network bandwidth (–Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –ø–æ —Å–µ—Ç–∏)
- Consumer processing (consumers –Ω–µ –≤–∏–¥—è—Ç –ª–∏—à–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è)

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω):** –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ consumers ‚Äî —Ç—Ä–∞—Ç–∏—Ç —Ä–µ—Å—É—Ä—Å—ã Kafka –∏ —Å–µ—Ç–∏.
</Callout>

## Pattern 2: Dynamic Include List (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥)

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ï—Å–ª–∏ –Ω—É–∂–µ–Ω —Å—Ç—Ä–æ–≥–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏ –≤ CDC –ø–∞–π–ø–ª–∞–π–Ω–µ.

### Workflow

**1. –î–æ –º–∏–≥—Ä–∞—Ü–∏–∏: –¥–æ–±–∞–≤–∏—Ç—å helper tables –≤ include list**

```json
{
  "name": "mysql-connector",
  "config": {
    "table.include.list": "mydb.orders,mydb.users,mydb._orders_gho,mydb._orders_ghc"
  }
}
```

**2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω—ë–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:**

```bash
curl -X PUT http://localhost:8083/connectors/mysql-connector/config \
  -H "Content-Type: application/json" \
  -d @connector-config-with-helpers.json
```

**3. –ó–∞–ø—É—Å—Ç–∏—Ç—å gh-ost –º–∏–≥—Ä–∞—Ü–∏—é:**

```bash
gh-ost --table=orders --alter="ADD COLUMN status VARCHAR(20)" --execute
```

**4. –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏: —É–¥–∞–ª–∏—Ç—å helper tables –∏–∑ include list**

```json
{
  "name": "mysql-connector",
  "config": {
    "table.include.list": "mydb.orders,mydb.users"
  }
}
```

**5. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–Ω–æ–≤–∞.**

### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ Dynamic Include List

- ‚ùå –¢—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞
- ‚ùå –†–∏—Å–∫ –∑–∞–±—ã—Ç—å —É–¥–∞–ª–∏—Ç—å helper tables –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚ùå –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö DDL –ø–∞–π–ø–ª–∞–π–Ω–æ–≤
- ‚ùå Helper table —Å–æ–±—ã—Ç–∏—è –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–ø–∞–¥–∞—é—Ç –≤ Kafka

**–í–µ—Ä–¥–∏–∫—Ç:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Pattern 1 (Broad Capture + Filter SMT) –∫–∞–∫ default –ø–æ–¥—Ö–æ–¥.

## gh-ost Integration: –ø–æ–ª–Ω—ã–π walkthrough

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞: Configure connector

```json
{
  "name": "mysql-connector-ghhost",
  "config": {
    "connector.class": "io.debezium.connector.mysql.MySqlConnector",
    "database.hostname": "mysql",
    "database.port": "3306",
    "database.user": "debezium",
    "database.password": "dbz",
    "database.server.id": "184001",
    "database.server.name": "mysql-server",
    "table.include.list": "inventory.*",
    "snapshot.mode": "when_needed",
    "schema.history.internal.kafka.topic": "schema-changes.mysql-server",
    "schema.history.internal.kafka.bootstrap.servers": "kafka:9092",
    "transforms": "FilterHelperTables",
    "transforms.FilterHelperTables.type": "io.debezium.transforms.Filter",
    "transforms.FilterHelperTables.language": "jsr223.groovy",
    "transforms.FilterHelperTables.condition": "!value.source.table.matches('.*_(gho|ghc)$')"
  }
}
```

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è gh-ost

```sql
CREATE USER 'gh-ost'@'%' IDENTIFIED BY 'ghp';
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER,
      LOCK TABLES, TRIGGER, REPLICATION SLAVE, REPLICATION CLIENT
      ON inventory.* TO 'gh-ost'@'%';
FLUSH PRIVILEGES;
```

### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç—å gh-ost –º–∏–≥—Ä–∞—Ü–∏—é

```bash
gh-ost \
  --host=mysql \
  --port=3306 \
  --user=gh-ost \
  --password=ghp \
  --database=inventory \
  --table=orders \
  --alter="ADD COLUMN status VARCHAR(20) DEFAULT 'pending'" \
  --assume-rbr \
  --allow-on-master \
  --exact-rowcount \
  --concurrent-rowcount \
  --chunk-size=1000 \
  --max-load=Threads_running=25 \
  --critical-load=Threads_running=50 \
  --default-retries=120 \
  --postpone-cut-over-flag-file=/tmp/ghost.postpone.flag \
  --execute
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `--assume-rbr` ‚Äî –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç binlog_format=ROW (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è CDC)
- `--allow-on-master` ‚Äî —Ä–∞–∑—Ä–µ—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É –Ω–∞ master (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `--migrate-on-replica` –¥–ª—è replica-based –º–∏–≥—Ä–∞—Ü–∏–∏)
- `--chunk-size=1000` ‚Äî –∫–æ–ø–∏—Ä—É–µ—Ç –ø–æ 1000 —Å—Ç—Ä–æ–∫ –∑–∞ chunk
- `--max-load` ‚Äî –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
- `--critical-load` ‚Äî –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
- `--postpone-cut-over-flag-file` ‚Äî –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–¥–µ—Ä–∂–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π rename (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –®–∞–≥ 3: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ gh-ost –ø—Ä–æ—Ü–µ—Å—Å–∞

gh-ost –≤—ã–≤–æ–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:

```
Copy: 25000/100000 25.0%; Applied: 1234; Backlog: 5/100; Time: 2m30s(total), 8m20s(remaining)
```

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ MySQL:**

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ helper tables
SHOW TABLES LIKE '%gho%';

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä ghost table
SELECT
  TABLE_NAME,
  TABLE_ROWS,
  DATA_LENGTH
FROM information_schema.TABLES
WHERE TABLE_SCHEMA = 'inventory' AND TABLE_NAME LIKE '%gho%';
```

### –®–∞–≥ 4: –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å Debezium

**–í–æ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏:**

1. Debezium –≤–∏–¥–∏—Ç CREATE TABLE —Å–æ–±—ã—Ç–∏—è –¥–ª—è `_orders_gho` –∏ `_orders_ghc`
2. –°—Ö–µ–º—ã —ç—Ç–∏—Ö —Ç–∞–±–ª–∏—Ü –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ schema history topic
3. Debezium –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç INSERT/UPDATE/DELETE —Å–æ–±—ã—Ç–∏—è –¥–ª—è –≤—Å–µ—Ö —Ç—Ä—ë—Ö —Ç–∞–±–ª–∏—Ü
4. **Filter SMT –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –æ—Ç `_orders_gho` –∏ `_orders_ghc`**
5. –¢–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏—è –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã `orders` –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ Kafka

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Debezium connector logs:**

```bash
docker logs -f kafka-connect | grep "orders"
```

–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:

```
INFO Creating topic 'mysql-server.inventory.orders'
INFO Processing CREATE TABLE for _orders_gho
INFO Processing CREATE TABLE for _orders_ghc
INFO Filtering event from _orders_gho (helper table)
INFO Processing event from orders
```

### –®–∞–≥ 5: –§–∏–Ω–∞–ª—å–Ω—ã–π rename (cut-over)

gh-ost –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω—ã–π rename:

```sql
RENAME TABLE
  `inventory`.`orders` TO `inventory`.`_orders_old`,
  `inventory`.`_orders_gho` TO `inventory`.`orders`;
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1. –û–±–µ —Ç–∞–±–ª–∏—Ü—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –Ω–∞ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
2. Rename –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ
3. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü–µ–π `orders` (–±—ã–≤—à–∞—è `_orders_gho`)

**–í Debezium:**

1. Schema history topic –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ RENAME
2. –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–±—ã—Ç–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–æ–≤—É—é —Å—Ö–µ–º—É (`orders` —Å –∫–æ–ª–æ–Ω–∫–æ–π `status`)
3. Consumers –≤–∏–¥—è—Ç –Ω–æ–≤—É—é –∫–æ–ª–æ–Ω–∫—É –≤ CDC —Å–æ–±—ã—Ç–∏—è—Ö

### –®–∞–≥ 6: Cleanup (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π)

gh-ost –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç helper tables:

```sql
DROP TABLE IF EXISTS `inventory`.`_orders_old`;
DROP TABLE IF EXISTS `inventory`.`_orders_ghc`;
```

**Debezium –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç DROP TABLE —Å–æ–±—ã—Ç–∏—è –≤ schema history.**

### –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—É—é —Å—Ö–µ–º—É
DESCRIBE inventory.orders;
-- –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–æ–ª–æ–Ω–∫–∞ 'status'

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ helper tables —É–¥–∞–ª–µ–Ω—ã
SHOW TABLES LIKE '%gho%';
-- Empty set (0.00 sec)

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
SELECT * FROM inventory.orders LIMIT 5;
```

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Kafka consumer:**

```bash
kafka-console-consumer \
  --bootstrap-server kafka:9092 \
  --topic mysql-server.inventory.orders \
  --from-beginning \
  --max-messages 5
```

–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥: —Å–æ–±—ã—Ç–∏—è —Å –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–æ–π `status`.

<Callout type="note">
**gh-ost –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç foreign keys**

–ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ `orders` –∏–º–µ–µ—Ç foreign key –∫ `customers`, gh-ost **–æ—Ç–∫–∞–∂–µ—Ç—Å—è** –≤—ã–ø–æ–ª–Ω—è—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:

```
FATAL Foreign key constraints are not supported. Run with --alter-foreign-keys-method=auto
```

**–†–µ—à–µ–Ω–∏—è:**
1. –í—Ä–µ–º–µ–Ω–Ω–æ —É–¥–∞–ª–∏—Ç—å FK: `ALTER TABLE orders DROP FOREIGN KEY fk_customer_id`
2. –í—ã–ø–æ–ª–Ω–∏—Ç—å gh-ost –º–∏–≥—Ä–∞—Ü–∏—é
3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å FK: `ALTER TABLE orders ADD CONSTRAINT fk_customer_id FOREIGN KEY (customer_id) REFERENCES customers(id)`

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ pt-online-schema-change (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç FK).
</Callout>

## pt-online-schema-change Integration: –ø–æ–ª–Ω—ã–π walkthrough

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞: Configure connector

–¢–∞ –∂–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, –Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –¥–ª—è pt-osc –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤:

```json
{
  "name": "mysql-connector-ptosc",
  "config": {
    "connector.class": "io.debezium.connector.mysql.MySqlConnector",
    "table.include.list": "inventory.*",
    "transforms": "FilterHelperTables",
    "transforms.FilterHelperTables.type": "io.debezium.transforms.Filter",
    "transforms.FilterHelperTables.language": "jsr223.groovy",
    "transforms.FilterHelperTables.condition": "!value.source.table.matches('.*_(new|old)$')"
  }
}
```

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è pt-osc

```sql
CREATE USER 'pt-osc'@'%' IDENTIFIED BY 'ptp';
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER,
      LOCK TABLES, TRIGGER, REPLICATION SLAVE, REPLICATION CLIENT
      ON inventory.* TO 'pt-osc'@'%';
FLUSH PRIVILEGES;
```

### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç—å pt-online-schema-change

```bash
pt-online-schema-change \
  --alter="ADD COLUMN priority INT DEFAULT 0" \
  --execute \
  --chunk-size=1000 \
  --max-load=Threads_running:25 \
  --critical-load=Threads_running:50 \
  --chunk-time=0.5 \
  --progress=time,30 \
  h=mysql,P=3306,u=pt-osc,p=ptp,D=inventory,t=orders
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `--chunk-size=1000` ‚Äî –∫–æ–ø–∏—Ä—É–µ—Ç –ø–æ 1000 —Å—Ç—Ä–æ–∫ –∑–∞ chunk
- `--max-load` ‚Äî –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
- `--critical-load` ‚Äî –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
- `--chunk-time=0.5` ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ chunk (0.5 —Å–µ–∫)
- `--progress=time,30` ‚Äî –≤—ã–≤–æ–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥

### –®–∞–≥ 3: –ß—Ç–æ –¥–µ–ª–∞–µ—Ç pt-osc

**1. –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É:**

```sql
CREATE TABLE `inventory`.`_orders_new` LIKE `inventory`.`orders`;
ALTER TABLE `inventory`.`_orders_new` ADD COLUMN priority INT DEFAULT 0;
```

**2. –°–æ–∑–¥–∞—ë—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã:**

```sql
-- Trigger for INSERT
CREATE TRIGGER `pt_osc_inventory_orders_ins`
AFTER INSERT ON `inventory`.`orders`
FOR EACH ROW
INSERT IGNORE INTO `inventory`.`_orders_new` (...) VALUES (...);

-- Trigger for UPDATE
CREATE TRIGGER `pt_osc_inventory_orders_upd`
AFTER UPDATE ON `inventory`.`orders`
FOR EACH ROW
REPLACE INTO `inventory`.`_orders_new` (...) VALUES (...);

-- Trigger for DELETE
CREATE TRIGGER `pt_osc_inventory_orders_del`
AFTER DELETE ON `inventory`.`orders`
FOR EACH ROW
DELETE IGNORE FROM `inventory`.`_orders_new` WHERE id = OLD.id;
```

**3. –ö–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ chunk-by-chunk:**

```sql
INSERT LOW_PRIORITY IGNORE INTO `inventory`.`_orders_new`
SELECT * FROM `inventory`.`orders`
WHERE id >= 1 AND id < 1001;

-- –°–ª–µ–¥—É—é—â–∏–π chunk
INSERT LOW_PRIORITY IGNORE INTO `inventory`.`_orders_new`
SELECT * FROM `inventory`.`orders`
WHERE id >= 1001 AND id < 2001;
```

**4. –§–∏–Ω–∞–ª—å–Ω—ã–π rename:**

```sql
RENAME TABLE
  `inventory`.`orders` TO `inventory`.`_orders_old`,
  `inventory`.`_orders_new` TO `inventory`.`orders`;
```

**5. –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—É—é —Ç–∞–±–ª–∏—Ü—É:**

```sql
DROP TABLE `inventory`.`_orders_old`;
```

### –®–∞–≥ 4: –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å Debezium

**–í–æ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏:**

1. Debezium –≤–∏–¥–∏—Ç CREATE TABLE `_orders_new`
2. Debezium –≤–∏–¥–∏—Ç CREATE TRIGGER —Å–æ–±—ã—Ç–∏—è (–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ schema history)
3. –ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å –≤ `orders` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç **2 —Å–æ–±—ã—Ç–∏—è:**
   - INSERT –≤ `orders` (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è)
   - INSERT –≤ `_orders_new` (—á–µ—Ä–µ–∑ trigger)
4. **Filter SMT –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –æ—Ç `_orders_new`**
5. Consumers –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏—è –æ—Ç `orders`

**–ü–æ—Å–ª–µ rename:**

1. `_orders_new` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `orders`
2. Debezium –≤–∏–¥–∏—Ç RENAME —Å–æ–±—ã—Ç–∏—è
3. Schema history –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
4. –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã `orders` —Å–æ–¥–µ—Ä–∂–∞—Ç –∫–æ–ª–æ–Ω–∫—É `priority`

### –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—É—é —Å—Ö–µ–º—É
DESCRIBE inventory.orders;
-- –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–æ–ª–æ–Ω–∫–∞ 'priority'

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã
SHOW TRIGGERS FROM inventory LIKE 'orders';
-- Empty set (0.00 sec)

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ _orders_old —É–¥–∞–ª–µ–Ω–∞
SHOW TABLES LIKE '%old%';
-- Empty set (0.00 sec)
```

<Callout type="note">
**pt-osc –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç foreign keys**

–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç gh-ost, pt-online-schema-change –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã —Å foreign keys. –¢—Ä–∏–≥–≥–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç FK constraints.

**–ü—Ä–∏–º–µ—Ä:**

```sql
-- –¢–∞–±–ª–∏—Ü–∞ —Å FK
CREATE TABLE orders (
  id INT PRIMARY KEY,
  customer_id INT,
  FOREIGN KEY (customer_id) REFERENCES customers(id)
);

-- pt-osc —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç –º–∏–≥—Ä–∞—Ü–∏—é
pt-online-schema-change --alter="ADD COLUMN status VARCHAR(20)" ...
```

–¢—Ä–∏–≥–≥–µ—Ä—ã –±—É–¥—É—Ç —Å–æ–±–ª—é–¥–∞—Ç—å FK constraints –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.
</Callout>

## Schema Evolution –≤ Consumers

### –ß—Ç–æ –≤–∏–¥—è—Ç consumers –ø–æ—Å–ª–µ DDL

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ (gh-ost –∏–ª–∏ pt-osc), –Ω–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ CDC —Å–æ–±—ã—Ç–∏—è—Ö:

**–î–æ –º–∏–≥—Ä–∞—Ü–∏–∏:**

```json
{
  "schema": {
    "fields": [
      {"field": "id", "type": "int32"},
      {"field": "customer_id", "type": "int32"},
      {"field": "created_at", "type": "string"}
    ]
  },
  "payload": {
    "after": {
      "id": 1,
      "customer_id": 42,
      "created_at": "2026-02-01T10:00:00Z"
    }
  }
}
```

**–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:**

```json
{
  "schema": {
    "fields": [
      {"field": "id", "type": "int32"},
      {"field": "customer_id", "type": "int32"},
      {"field": "created_at", "type": "string"},
      {"field": "status", "type": "string", "optional": true}
    ]
  },
  "payload": {
    "after": {
      "id": 2,
      "customer_id": 43,
      "created_at": "2026-02-01T10:05:00Z",
      "status": "pending"
    }
  }
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ schema evolution –≤ consumers

**Avro + Schema Registry (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):**

```java
// Schema Registry –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç backward/forward compatibility
GenericRecord record = reader.read();
String status = record.hasField("status")
  ? record.get("status").toString()
  : "unknown";
```

**JSON Schema:**

```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—è
const status = event.payload.after.status || 'unknown';
```

<Callout type="warning">
**Incompatible schema changes —Ç—Ä–µ–±—É—é—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏**

–ù–µ–∫–æ—Ç–æ—Ä—ã–µ DDL –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–º–∞—é—Ç consumers:

**Breaking changes:**
- `DROP COLUMN email` ‚Äî consumers –æ–∂–∏–¥–∞—é—Ç –ø–æ–ª–µ, –∫–æ—Ç–æ—Ä–æ–≥–æ –±–æ–ª—å—à–µ –Ω–µ—Ç
- `CHANGE COLUMN id BIGINT` ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞ –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é
- `RENAME TABLE orders TO sales` ‚Äî consumers —Å–ª—É—à–∞—é—Ç —Å—Ç–∞—Ä—ã–π —Ç–æ–ø–∏–∫

**Best practice workflow:**
1. Deploy new consumer version (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–µ —Å—Ö–µ–º—ã)
2. –í—ã–ø–æ–ª–Ω–∏—Ç—å DDL –º–∏–≥—Ä–∞—Ü–∏—é
3. –ü–æ–¥–æ–∂–¥–∞—Ç—å, –ø–æ–∫–∞ —Å—Ç–∞—Ä—ã–µ consumers –æ–±—Ä–∞–±–æ—Ç–∞—é—Ç backlog
4. Deploy final consumer version (—Ç–æ–ª—å–∫–æ –Ω–æ–≤–∞—è —Å—Ö–µ–º–∞)
</Callout>

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ DDL –æ–ø–µ—Ä–∞—Ü–∏–π

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

**1. Connector health:**

```bash
curl http://localhost:8083/connectors/mysql-connector/status | jq .connector.state
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å "RUNNING"
```

**2. Schema history topic —Ä–∞–∑–º–µ—Ä:**

```bash
kafka-log-dirs --bootstrap-server kafka:9092 \
  --topic-list schema-changes.mysql-server \
  --describe | grep size
```

–í–æ –≤—Ä–µ–º—è DDL –º–∏–≥—Ä–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä –¥–æ–ª–∂–µ–Ω —É–≤–µ–ª–∏—á–∏—Ç—å—Å—è (–Ω–æ–≤—ã–µ DDL —Å–æ–±—ã—Ç–∏—è).

**3. Binlog lag:**

```sql
SHOW SLAVE STATUS\G
-- Seconds_Behind_Master –º–æ–∂–µ—Ç –≤—ã—Ä–∞—Å—Ç–∏ –≤–æ –≤—Ä–µ–º—è gh-ost (—á–∏—Ç–∞–µ—Ç binlog)
```

**4. Kafka topic creation:**

```bash
kafka-topics --bootstrap-server kafka:9092 --list | grep gho
# –í–æ –≤—Ä–µ–º—è gh-ost –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Ç–æ–ø–∏–∫–∏ –¥–ª—è _orders_gho, _orders_ghc
```

**5. –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏: cleanup verification:**

```bash
kafka-topics --bootstrap-server kafka:9092 --list | grep gho
# –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ helper table —Ç–æ–ø–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞—Ç—å—Å—è (–Ω–æ –±–µ–∑ –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π)
```

### –ê–ª–µ—Ä—Ç—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

```yaml
# Prometheus AlertManager rules (–ø—Ä–∏–º–µ—Ä)
groups:
  - name: debezium_ddl_monitoring
    rules:
      - alert: DebeziumConnectorFailedDuringDDL
        expr: |
          kafka_connect_connector_status{connector="mysql-connector",state="FAILED"} == 1
        for: 1m
        annotations:
          summary: "Debezium connector failed (possibly during DDL operation)"

      - alert: HelperTablesNotCleaned
        expr: |
          kafka_topic_partitions{topic=~".*_(gho|ghc|new|old)"} > 0
        for: 24h
        annotations:
          summary: "Helper table topics exist 24h after migration (investigate)"
```

## Common Mistakes (—á–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏)

### 1. –ù–µ –≤–∫–ª—é—á–∏—Ç—å helper tables –≤ capture

**–û—à–∏–±–∫–∞:**

```json
{
  "table.include.list": "inventory.orders,inventory.users"
}
```

**–ó–∞–ø—É—Å–∫–∞–µ—Ç–µ gh-ost –Ω–∞ orders ‚Üí connector crash:**

```
ERROR: Table _orders_gho not found in schema history topic
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**

```json
{
  "table.include.list": "inventory.*"
}
```

---

### 2. –ó–∞–±—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä SMT

**–û—à–∏–±–∫–∞:** Helper tables –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è, –Ω–æ –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- Consumers –≤–∏–¥—è—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Å–æ–±—ã—Ç–∏—è
- Kafka storage —Ä–∞—Å—Ö–æ–¥—É–µ—Ç—Å—è –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ü—É—Ç–∞–Ω–∏—Ü–∞ –≤ downstream —Å–∏—Å—Ç–µ–º–∞—Ö

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å Filter SMT (Pattern 1).

---

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å DDL –≤–æ –≤—Ä–µ–º—è snapshot

**–û—à–∏–±–∫–∞:** Debezium –≤—ã–ø–æ–ª–Ω—è–µ—Ç initial snapshot, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç gh-ost –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- gh-ost –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É –¥–ª—è rename
- Snapshot timeout (—Ç–∞–±–ª–∏—Ü–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ gh-ost)
- Connector retry loop

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è snapshot, –∑–∞—Ç–µ–º –∑–∞–ø—É—Å–∫–∞–π—Ç–µ DDL.

---

### 4. gh-ost –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ —Å FK

**–û—à–∏–±–∫–∞:**

```bash
gh-ost --table=orders --alter="..." --execute
```

**orders –∏–º–µ–µ—Ç foreign key ‚Üí gh-ost –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω—è—Ç—å:**

```
FATAL: Foreign key constraints are not supported
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ pt-online-schema-change –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ —É–¥–∞–ª–∏—Ç–µ FK.

---

## Hands-on Exercise: gh-ost —Å CDC

### Prerequisites

- MySQL –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è —Å Docker Compose
- Debezium connector —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç —Å —à–∏—Ä–æ–∫–∏–º capture pattern
- Filter SMT –Ω–∞—Å—Ç—Ä–æ–µ–Ω

### Exercise Steps

**1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ö–µ–º—É:**

```sql
DESCRIBE inventory.orders;
```

**2. Deploy connector —Å Filter SMT:**

```bash
curl -X POST http://localhost:8083/connectors \
  -H "Content-Type: application/json" \
  -d '{
    "name": "mysql-connector-ghhost",
    "config": {
      "connector.class": "io.debezium.connector.mysql.MySqlConnector",
      "database.hostname": "mysql",
      "database.port": "3306",
      "database.user": "debezium",
      "database.password": "dbz",
      "database.server.id": "184001",
      "database.server.name": "mysql-server",
      "table.include.list": "inventory.*",
      "snapshot.mode": "initial",
      "schema.history.internal.kafka.topic": "schema-changes.mysql-server",
      "schema.history.internal.kafka.bootstrap.servers": "kafka:9092",
      "transforms": "FilterHelperTables",
      "transforms.FilterHelperTables.type": "io.debezium.transforms.Filter",
      "transforms.FilterHelperTables.language": "jsr223.groovy",
      "transforms.FilterHelperTables.condition": "!value.source.table.matches('\''.*_(gho|ghc)$'\'')"
    }
  }'
```

**3. –ó–∞–ø—É—Å—Ç–∏—Ç—å gh-ost –º–∏–≥—Ä–∞—Ü–∏—é:**

```bash
docker exec -it mysql bash

gh-ost \
  --host=127.0.0.1 \
  --user=root \
  --password=debezium \
  --database=inventory \
  --table=orders \
  --alter="ADD COLUMN status VARCHAR(20) DEFAULT 'pending'" \
  --assume-rbr \
  --allow-on-master \
  --exact-rowcount \
  --chunk-size=100 \
  --execute
```

**4. –ù–∞–±–ª—é–¥–∞—Ç—å connector logs:**

```bash
docker logs -f kafka-connect | grep -E "(orders|gho|ghc)"
```

–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:

```
INFO Creating topic for _orders_gho
INFO Filtering event from _orders_gho
INFO Processing event from orders
```

**5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Kafka consumer (—Ç–æ–ª—å–∫–æ orders —Å–æ–±—ã—Ç–∏—è):**

```bash
kafka-console-consumer \
  --bootstrap-server kafka:9092 \
  --topic mysql-server.inventory.orders \
  --from-beginning \
  --max-messages 10
```

**6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å schema history topic:**

```bash
kafka-console-consumer \
  --bootstrap-server kafka:9092 \
  --topic schema-changes.mysql-server \
  --from-beginning \
  --property print.key=true \
  | grep -E "(gho|ALTER)"
```

–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥: CREATE TABLE –¥–ª—è `_orders_gho`, ALTER TABLE –¥–ª—è `orders`.

**7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—É—é —Å—Ö–µ–º—É –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:**

```sql
DESCRIBE inventory.orders;
-- –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–æ–ª–æ–Ω–∫–∞ 'status'
```

**8. Bonus: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ helper table —Ç–æ–ø–∏–∫–∏ –ø—É—Å—Ç—ã–µ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:**

```bash
kafka-console-consumer \
  --bootstrap-server kafka:9092 \
  --topic mysql-server.inventory._orders_gho \
  --from-beginning \
  --max-messages 1 \
  --timeout-ms 5000
```

–ï—Å–ª–∏ Filter SMT —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ: timeout (–Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π).

---

## Summary: DDL Tools Checklist

**Pre-migration:**

- [ ] Debezium connector –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å —à–∏—Ä–æ–∫–∏–º capture pattern (`mydb.*`)
- [ ] Filter SMT –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞
- [ ] Regex —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ helper table –ø–∞—Ç—Ç–µ—Ä–Ω—ã (`_gho`, `_ghc`, `_new`, `_old`)
- [ ] Connector status: RUNNING
- [ ] Schema history topic retention: infinite (`retention.ms=-1`)

**During migration:**

- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ connector logs (–Ω–µ—Ç –æ—à–∏–±–æ–∫ missing table)
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ binlog lag (–º–æ–∂–µ—Ç –≤—ã—Ä–∞—Å—Ç–∏ –≤–æ –≤—Ä–µ–º—è gh-ost)
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ Kafka topics (helper table —Ç–æ–ø–∏–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è, –Ω–æ —Å–æ–±—ã—Ç–∏—è —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è)

**Post-migration:**

- [ ] –ù–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ –ø–æ—è–≤–∏–ª–∞—Å—å –≤ CDC —Å–æ–±—ã—Ç–∏—è—Ö
- [ ] Schema history topic —Å–æ–¥–µ—Ä–∂–∏—Ç DDL —Å–æ–±—ã—Ç–∏—è (CREATE, ALTER, DROP)
- [ ] Helper tables —É–¥–∞–ª–µ–Ω—ã –∏–∑ MySQL (`SHOW TABLES` –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `_gho`, `_new`)
- [ ] Consumers –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Å–æ–±—ã—Ç–∏—è —Å –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π
- [ ] Helper table —Ç–æ–ø–∏–∫–∏ –≤ Kafka –ø—É—Å—Ç—ã–µ (–∏–ª–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã –≤—Ä—É—á–Ω—É—é)

---

## –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

1. **Standard ALTER TABLE –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É** ‚Äî –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü —ç—Ç–æ downtime –Ω–∞ —á–∞—Å—ã
2. **gh-ost –∏ pt-osc –≤—ã–ø–æ–ª–Ω—è—é—Ç zero-downtime DDL** ‚Äî —á–µ—Ä–µ–∑ helper tables –∏ chunked copy
3. **gh-ost triggerless, —á–∏—Ç–∞–µ—Ç binlog** ‚Äî —É–¥–≤–∞–∏–≤–∞–µ—Ç binlog read –Ω–∞–≥—Ä—É–∑–∫—É, –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç FK
4. **pt-osc trigger-based** ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç FK, –¥–æ–±–∞–≤–ª—è–µ—Ç trigger overhead
5. **Helper tables –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ table.include.list** ‚Äî –∏–Ω–∞—á–µ connector crash
6. **Filter SMT ‚Äî recommended pattern** ‚Äî —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç helper table —Å–æ–±—ã—Ç–∏—è –ø–µ—Ä–µ–¥ Kafka
7. **Regex filter –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã** ‚Äî `_gho`, `_ghc`, `_new`, `_old`
8. **Schema evolution –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è** ‚Äî –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ CDC —Å–æ–±—ã—Ç–∏—è—Ö
9. **Avro + Schema Registry —É–ø—Ä–æ—â–∞—é—Ç schema evolution** ‚Äî backward/forward compatibility
10. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ connector logs –∫—Ä–∏—Ç–∏—á–µ–Ω** ‚Äî –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã –≤–æ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏

## –ß—Ç–æ –¥–∞–ª—å—à–µ?

–ú—ã —Ä–∞–∑–æ–±—Ä–∞–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –æ–Ω–ª–∞–π–Ω-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ DDL —Å Debezium MySQL CDC. –í—ã –Ω–∞—É—á–∏–ª–∏—Å—å –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å schema migrations –±–µ–∑ downtime –∏ –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ CDC-–ø–∞–π–ø–ª–∞–π–Ω–µ.

–í —Å–ª–µ–¥—É—é—â–∏—Ö —É—Ä–æ–∫–∞—Ö –º—ã –∏–∑—É—á–∏–º advanced recovery —Å—Ü–µ–Ω–∞—Ä–∏–∏: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ—Ç–µ—Ä–∏ binlog position, –∫–æ—Ä—Ä–µ–∫—Ü–∏—è schema history topic, multi-connector deployments —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º server.id conflicts, –∏ incremental snapshots –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ streaming.
